<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edit Expense</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        body { font-family: -apple-system, sans-serif; padding: 20px; background-color: #f4f4f9; color: #333; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); max-width: 500px; margin: auto; position: relative; min-height: 400px;}
        h3 { color: #1DB446; margin-top: 0; }
        input { width: 100%; padding: 12px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 16px; }
        .btn { width: 100%; padding: 12px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; margin-top: 5px; color: white; font-size: 16px; }
        .btn-search { background-color: #007bff; }
        .btn-save { background-color: #1DB446; }
        .btn-del { background-color: #dc3545; margin-top: 15px;}
        .btn-cancel { background-color: #6c757d; margin-top: 5px;}
        #edit-section, #review-section { display: none; border-top: 1px solid #eee; margin-top: 20px; padding-top: 20px; }
        label { font-size: 12px; font-weight: bold; color: #555; display: block; margin-bottom: 4px; }
        #loading { display:none; color: #666; text-align: center; margin-top: 10px; font-weight: bold;}
        .review-box { background-color: #f8f9fa; border: 1px solid #ddd; padding: 15px; border-radius: 8px; margin-bottom: 15px; }
        .review-row { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 14px; border-bottom: 1px dashed #eee; padding-bottom: 4px;}
        #bottom-message { text-align: center; margin-top: 20px; font-weight: bold; font-size: 16px; min-height: 24px; }
        .success-text { color: #1DB446; }
        .error-text { color: #dc3545; }
    </style>
</head>
<body>

    <div class="card">
        <div id="search-section">
            <h3>üîç Search Expense</h3>
            <input type="text" id="searchRef" placeholder="Enter Ref Code (e.g. 9X2A)">
            <button class="btn btn-search" onclick="searchData()" id="searchBtn">Find Record</button>
            <div id="loading">Processing... Please wait.</div>
        </div>

        <div id="edit-section">
            <h3>‚úèÔ∏è Edit Details</h3>
            
            <label>Bill No</label>
            <input type="text" id="billNo">
            <label>Item No</label>
            <input type="text" id="itemNo">
            
            <label>Type</label>
            <input list="type-options" id="itemType" placeholder="Select or type...">
            <datalist id="type-options">
                <option value="Chair">
                <option value="Bed">
                <option value="Table">
            </datalist>

            <label>Description</label>
            <input type="text" id="desc">
            <label>Supplier</label>
            <input type="text" id="supplier">
            <label>Installment</label>
            <input type="text" id="instNo">
            <label>Amount</label>
            <input type="number" id="amount">

            <button class="btn btn-save" onclick="showReview('edit')">Review & Save</button>
            <button class="btn btn-del" onclick="showReview('delete')">Review & Delete</button>
            <button class="btn btn-cancel" onclick="location.reload()">Cancel</button>
        </div>

        <div id="review-section">
            <h3 id="review-title">üìã Confirm Details</h3>
            <div class="review-box">
                <div class="review-row"><strong>Ref:</strong> <span id="r-ref"></span></div>
                <div class="review-row"><strong>Bill:</strong> <span id="r-bill"></span></div>
                <div class="review-row"><strong>Item:</strong> <span id="r-item"></span></div>
                <div class="review-row"><strong>Type:</strong> <span id="r-type"></span></div>
                <div class="review-row"><strong>Desc:</strong> <span id="r-desc"></span></div>
                <div class="review-row"><strong>Supplier:</strong> <span id="r-supp"></span></div>
                <div class="review-row"><strong>Installment:</strong> <span id="r-inst"></span></div>
                <div class="review-row"><strong>Amount:</strong> <span id="r-amt" style="color:#1DB446; font-weight:bold;"></span></div>
                <div class="review-row"><strong>Action:</strong> <span id="r-action" style="font-weight:bold;"></span></div>
            </div>
            
            <button class="btn btn-save" id="confirmBtn" onclick="executeFinalAction()">Confirm & Send</button>
            <button class="btn btn-cancel" onclick="backToEdit()">Back to Edit</button>
        </div>

        <div id="bottom-message"></div>
    </div>

    <script>
        const CONFIG = {
            liffId: "2009011182-W7GaHRTL", 
            scriptUrl: "https://script.google.com/macros/s/AKfycby17s2vUqmaLRg8NUmBi2C4XIIVciDRXFHviGYYiTiVl6v9ieLd0i7K-EC63s4ph3ZAIQ/exec" 
        };

        let PENDING_ACTION = ""; 

        async function main() {
            try {
                await liff.init({ liffId: CONFIG.liffId });
                if (!liff.isLoggedIn()) liff.login();
            } catch (err) { console.error("LIFF Init failed", err); }
        }
        main();

        async function searchData() {
            const refCode = document.getElementById('searchRef').value.trim();
            const btn = document.getElementById('searchBtn');
            const loading = document.getElementById('loading');
            
            if (!refCode) { alert("Please enter a Ref Code"); return; }
            btn.disabled = true; loading.style.display = 'block';

            try {
                const response = await fetch(`${CONFIG.scriptUrl}?ref=${refCode}`, { method: "GET", redirect: "follow" });
                const data = await response.json();

                if (data.found) {
                    document.getElementById('billNo').value = data.bill;
                    document.getElementById('itemNo').value = data.item;
                    document.getElementById('itemType').value = data.type || ""; 
                    document.getElementById('desc').value = data.desc;
                    document.getElementById('supplier').value = data.supplier;
                    document.getElementById('instNo').value = data.inst;
                    document.getElementById('amount').value = data.amount;

                    document.getElementById('search-section').style.display = 'none';
                    document.getElementById('edit-section').style.display = 'block';
                } else {
                    alert("Ref Code not found!");
                    btn.disabled = false; loading.style.display = 'none';
                }
            } catch (err) { alert("Error connecting to database"); btn.disabled = false; loading.style.display = 'none'; }
        }

        function showReview(actionType) {
            PENDING_ACTION = actionType;
            const ref = document.getElementById('searchRef').value;
            const bill = document.getElementById('billNo').value;
            const item = document.getElementById('itemNo').value;
            const type = document.getElementById('itemType').value;
            const desc = document.getElementById('desc').value;
            const supp = document.getElementById('supplier').value;
            const inst = document.getElementById('instNo').value;
            const amt = document.getElementById('amount').value;

            if(!bill || !amt) { alert("Bill No and Amount are required!"); return; }

            document.getElementById('r-ref').innerText = ref;
            document.getElementById('r-bill').innerText = bill;
            document.getElementById('r-item').innerText = item;
            document.getElementById('r-type').innerText = type || "-";
            document.getElementById('r-desc').innerText = desc;
            document.getElementById('r-supp').innerText = supp;
            document.getElementById('r-inst').innerText = inst;
            document.getElementById('r-amt').innerText = "‡∏ø" + Number(amt).toLocaleString();
            
            const actionSpan = document.getElementById('r-action');
            if(actionType === 'delete') {
                actionSpan.innerText = "DELETE RECORD"; actionSpan.style.color = "red";
                document.getElementById('confirmBtn').style.backgroundColor = "#dc3545";
            } else {
                actionSpan.innerText = "UPDATE RECORD"; actionSpan.style.color = "#1DB446";
                document.getElementById('confirmBtn').style.backgroundColor = "#1DB446";
            }

            document.getElementById('edit-section').style.display = 'none';
            document.getElementById('review-section').style.display = 'block';
        }

        function backToEdit() {
            document.getElementById('review-section').style.display = 'none';
            document.getElementById('edit-section').style.display = 'block';
        }

        async function executeFinalAction() {
            const btn = document.getElementById('confirmBtn');
            btn.disabled = true; btn.innerText = "Sending...";
            
            const payload = {
                authKey: "PNGL",
                action: PENDING_ACTION,
                refCode: document.getElementById('searchRef').value,
                bill: document.getElementById('billNo').value,
                item: document.getElementById('itemNo').value,
                type: document.getElementById('itemType').value || "-", 
                desc: document.getElementById('desc').value || "-",
                supplier: document.getElementById('supplier').value || "-",
                inst: document.getElementById('instNo').value || "-",
                amount: document.getElementById('amount').value
            };

            try {
                await fetch(CONFIG.scriptUrl, { method: 'POST', mode: 'no-cors', body: JSON.stringify(payload) });

                if (liff.isInClient()) {
                    let msg = "";
                    if (PENDING_ACTION === 'delete') {
                        msg = `‚ùå *Delete*\n\n` +
                              `‚Ä¢ Bill No: ${payload.bill}\n` +
                              `‚Ä¢ Item No: ${payload.item}\n` +
                              `‚Ä¢ Type: ${payload.type}\n` +
                              `‚Ä¢ Desc: ${payload.desc}\n` +
                              `‚Ä¢ Supplier: ${payload.supplier}\n` +
                              `‚Ä¢ Installment: ${payload.inst}\n` +
                              `‚Ä¢ Amount: ‡∏ø${Number(payload.amount).toLocaleString()}\n` +
                              `‚Ä¢ Ref: ${payload.refCode}`;
                    } else {
                        // FULL REPORT FOR EDIT
                        msg = `üîß *Edited*\n\n` +
                              `‚Ä¢ Bill No: ${payload.bill}\n` +
                              `‚Ä¢ Item No: ${payload.item}\n` +
                              `‚Ä¢ Type: ${payload.type}\n` +
                              `‚Ä¢ Desc: ${payload.desc}\n` +
                              `‚Ä¢ Supplier: ${payload.supplier}\n` +
                              `‚Ä¢ Installment: ${payload.inst}\n` +
                              `‚Ä¢ Amount: ‡∏ø${Number(payload.amount).toLocaleString()}\n` +
                              `‚Ä¢ Ref: ${payload.refCode}`;
                    }
                    await liff.sendMessages([{ type: 'text', text: msg }, { type: 'text', text: payload.refCode }]);
                }

                document.getElementById('review-section').style.display = 'none';
                document.getElementById('bottom-message').innerText = "‚úÖ Success! Closing...";
                setTimeout(() => { if (liff.isInClient()) liff.closeWindow(); else location.reload(); }, 2000);
            } catch (err) {
                document.getElementById('bottom-message').innerText = "Error: " + err.message;
                btn.disabled = false;
            }
        }
    </script>
</body>
</html>
